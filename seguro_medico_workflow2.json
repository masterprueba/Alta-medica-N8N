{
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -1360,
        -580
      ],
      "id": "83d98569-aeac-4846-b75b-ff67476d18ad",
      "name": "Telegram Trigger",
      "webhookId": "d4e5f6a7-8c1a-4c5b-9e2a-1f3d4e5f6a7b",
      "credentials": {
        "telegramApi": {
          "id": "vFDkoakc66jpL2B0",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -120,
        -360
      ],
      "id": "4b9fbc43-d6c9-44af-91fd-573471e82d79",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "145WhwbclghvLwkm",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=CONTEXTO DEL PROCESO:\n- Mensaje del usuario: \"{{ $('Code un solo texto').item.json.mensajeUsuario }}\"\n\n\nINSTRUCCIONES:\n1. Si ya hay datos recopilados, ÃšSALOS para continuar el proceso\n2. Si el usuario responde a una pregunta, extrae y valida esa informaciÃ³n\n3. Avanza al siguiente paso solo si la respuesta es vÃ¡lida\n4. Si hay errores, pide clarificaciÃ³n sin avanzar\n5. Siempre responde todo los datos extraidos\n6. Si se creo numero de poliza a si no tenga\n\nPASOS DEL PROCESO:\ninicio â†’ nombre â†’ apellido â†’ edad â†’ telefono â†’ direccion â†’ email â†’ condiciones_medicas â†’ confirmacion â†’ finalizado\n\nRESPONDEME CON UN JSON SIEMPRE",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "Eres un asistente inteligente para alta de seguro mÃ©dico. Analizas los datos extraÃ­dos de la conversaciÃ³n anterior\n\n## COMPORTAMIENTO INTELIGENTE:\n- Cuando pidas el nombre, no pidas el nombre completo. solo pide el nombre para que despuÃ©s te de el apellido\n- Si ya hay datos recopilados (ej: nombre=\"Juan\"), NO los vuelvas a pedir\n- ContinÃºa desde el siguiente paso que falta\n- Si el usuario responde a tu pregunta, extrae y valida esa informaciÃ³n\n- Si el usuario no te entrega bien los datos pÃ­dele que lo digite nuevamente porque el dato suministrado no es correcto\n- Si el usuario te dice que no tiene condiciones medicas, no insistas y avanza al siguiente paso\n- Cuando preguntes al usuario Â¿confirma que todos los datos son correctos. antes haz un resumen de los datos que diligencio\n- Especifica al usuario que no puedes realizar alguna tarea que te pida cuando en verdad no puedes hacerla. recuerda que solo tienes 2 herramientas\n- MantÃ©n contexto de toda la conversaciÃ³n\n- finalizado con Ã©xito y se le envÃ­a un correo con el detalle\n\n## PASOS:\ninicioâ†’nombreâ†’apellidoâ†’edadâ†’telefonoâ†’direccionâ†’emailâ†’condiciones_medicasâ†’confirmacionâ†’finalizado\n\n## TIPO DE DATOs\n\nnombre VARCHAR(100) NOT NULL,\napellido VARCHAR(100) NOT NULL,\nedad INTEGER NOT NULL CHECK (edad >= 18 AND edad <= 80),\ntelefono VARCHAR(20) NOT NULL,\ndireccion TEXT NOT NULL,\nemail VARCHAR(255) NOT NULL,\ncondiciones_medicas TEXT\n\n\n## HERRAMIENTAS PARA QUE USES\n- validar email: usa siempre para validar el email\n- validar edad: usa siempre para validar la edad\n- create usuarios_seguros: guardar si ya el usuario confirmo todos los datos\n- Get usuarios_seguros: validar antes de guardar si ya existe. con esto evitas intentar guardar duplicados y generar errores\n\n##VALIDACIONES\n\"email\": \"Debe ser un email vÃ¡lido\",\n\"edad\": \"Debe estar entre 18 y 80 aÃ±os\",\n\"campos_obligatorios\": \"Todos los campos son obligatorios excepto condiciones_medicas\"\n\n## RESPUESTA JSON\n{ \"respuesta\": \"Tu mensaje amigable al usuario\",\n  \"paso\": \"continuar|validar|confirmar|finalizado\",\n  \"datos_extraidos\": \"tipo json con los datos del usuario\"\n}\n\n##A TENER EN CUENTA\nen la respuesta que entregues, si en el campo \"paso\" colocas \"finalizado\" o \"finalizar\" el proceso enviara un correo electrÃ³nico con el numero de pÃ³liza\nRecuerda hacer un resume de los datos"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        172,
        -580
      ],
      "id": "f8793a76-8e3b-4a9e-89cb-4959aa46db6f",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "tableId": "usuarios_seguros",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{$('Telegram Trigger').first().json.message.from.id}}"
            },
            {
              "fieldId": "nombre",
              "fieldValue": "={{$fromAI(\"nombre\",\"Nombre digitado por el usuario\")}}"
            },
            {
              "fieldId": "apellido",
              "fieldValue": "={{$fromAI(\"apellido\",\"Apellido digitado por el usuario\")}}"
            },
            {
              "fieldId": "edad",
              "fieldValue": "={{$fromAI(\"edad\",\"Edad digitada por el usuario\")}}"
            },
            {
              "fieldId": "telefono",
              "fieldValue": "={{$fromAI(\"telefono\",\"Telefono digitado por el usuario\")}}"
            },
            {
              "fieldId": "direccion",
              "fieldValue": "={{$fromAI(\"direccion\",\"Direccion digitado por el usuario\")}}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{$fromAI(\"email\",\"Email digitado por el usuario\")}}"
            },
            {
              "fieldId": "condiciones_medicas",
              "fieldValue": "={{$fromAI(\"condicion_medica\",\"Condicion_medica digitada por el usuario\")}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        200,
        -380
      ],
      "id": "600e777a-c57e-4491-a7ed-17e20d941cac",
      "name": "create usuarios_seguros",
      "credentials": {
        "supabaseApi": {
          "id": "FBCdtgZlNfvohdVd",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.output.parseJson().respuesta }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        760,
        -580
      ],
      "id": "74b63b35-7b89-46e6-8bf3-676fcf1f29b7",
      "name": "Telegram",
      "webhookId": "60498330-361e-41e5-8845-b9f3c6b76fe0",
      "credentials": {
        "telegramApi": {
          "id": "vFDkoakc66jpL2B0",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        40,
        -360
      ],
      "id": "fcc0a240-94f5-435f-89f9-79e2cfdca81d",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "dGtXw0VoEXa4yovM",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Generar nÃºmero de pÃ³liza Ãºnico\nlet numeroPoliza = \"\"+$('primero obtener datos').first().json.numero_poliza\nif (numeroPoliza) {\n  numeroPoliza = 'POL-' + Date.now() + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();\n}\n\n\n// obtener datos\nconst datosUsuario = $('obtener datos').first().json.datos_recopilados;\n\nconst mensajeConfirmacion = `\n<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>ConfirmaciÃ³n de Alta - Seguro MÃ©dico</title>\n</head>\n<body style=\"margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;\">\n    <div style=\"max-width: 600px; margin: 0 auto; background-color: #ffffff; box-shadow: 0 4px 6px rgba(0,0,0,0.1);\">\n        \n        <!-- Header -->\n        <div style=\"background: linear-gradient(135deg, #4CAF50, #45a049); padding: 30px; text-align: center;\">\n            <h1 style=\"color: white; margin: 0; font-size: 28px; font-weight: bold;\">\n                ğŸ‰ Â¡Felicidades ${datosUsuario.nombre}!\n            </h1>\n            <p style=\"color: #e8f5e8; margin: 10px 0 0 0; font-size: 16px;\">\n                Tu alta en el seguro mÃ©dico ha sido completada exitosamente\n            </p>\n        </div>\n\n        <!-- Success Message -->\n        <div style=\"padding: 30px; text-align: center; background-color: #f8fff8; border-left: 4px solid #4CAF50;\">\n            <div style=\"font-size: 48px; margin-bottom: 15px;\">âœ…</div>\n            <h2 style=\"color: #2e7d32; margin: 0; font-size: 22px;\">\n                Â¡Proceso Completado con Ã‰xito!\n            </h2>\n        </div>\n\n        <!-- Policy Details -->\n        <div style=\"padding: 30px;\">\n            <h3 style=\"color: #333; font-size: 20px; margin: 0 0 20px 0; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;\">\n                ğŸ“‹ Resumen de tu PÃ³liza\n            </h3>\n            \n            <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\n                <tr style=\"background-color: #f9f9f9;\">\n                    <td style=\"padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #555; width: 40%;\">\n                        ğŸ“„ NÃºmero de PÃ³liza:\n                    </td>\n                    <td style=\"padding: 12px; border: 1px solid #ddd; color: #333; font-weight: bold; font-size: 16px;\">\n                        ${numeroPoliza}\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #555;\">\n                        ğŸ‘¤ Titular:\n                    </td>\n                    <td style=\"padding: 12px; border: 1px solid #ddd; color: #333;\">\n                        ${datosUsuario.nombre} ${datosUsuario.apellido}\n                    </td>\n                </tr>\n                <tr style=\"background-color: #f9f9f9;\">\n                    <td style=\"padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #555;\">\n                        ğŸ‚ Edad:\n                    </td>\n                    <td style=\"padding: 12px; border: 1px solid #ddd; color: #333;\">\n                        ${datosUsuario.edad} aÃ±os\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #555;\">\n                        ğŸ“ TelÃ©fono:\n                    </td>\n                    <td style=\"padding: 12px; border: 1px solid #ddd; color: #333;\">\n                        ${datosUsuario.telefono}\n                    </td>\n                </tr>\n                <tr style=\"background-color: #f9f9f9;\">\n                    <td style=\"padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #555;\">\n                        ğŸ“§ Email:\n                    </td>\n                    <td style=\"padding: 12px; border: 1px solid #ddd; color: #333;\">\n                        ${datosUsuario.email}\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #555;\">\n                        ğŸ“… Fecha de Alta:\n                    </td>\n                    <td style=\"padding: 12px; border: 1px solid #ddd; color: #333;\">\n                        ${new Date().toLocaleDateString('es-ES')}\n                    </td>\n                </tr>\n            </table>\n        </div>\n\n        <!-- Important Information -->\n        <div style=\"background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 0 30px 30px 30px;\">\n            <h4 style=\"color: #856404; margin: 0 0 15px 0; font-size: 18px;\">\n                ğŸ“§ InformaciÃ³n Importante\n            </h4>\n            <p style=\"margin: 0 0 10px 0; color: #856404; line-height: 1.6;\">\n                En breves minutos recibirÃ¡s un email con todos los detalles de tu pÃ³liza.\n            </p>\n            <p style=\"margin: 0; color: #856404; line-height: 1.6; font-weight: bold;\">\n                ğŸ¥ Tu cobertura mÃ©dica estarÃ¡ activa en 24 horas.\n            </p>\n        </div>\n\n        <!-- Next Steps -->\n        <div style=\"padding: 0 30px 30px 30px;\">\n            <h4 style=\"color: #333; font-size: 18px; margin: 0 0 15px 0;\">\n                ğŸ“‹ PrÃ³ximos Pasos\n            </h4>\n            <div style=\"background-color: #f8f9fa; border-radius: 8px; padding: 20px;\">\n                <ol style=\"margin: 0; padding-left: 20px; color: #555; line-height: 1.8;\">\n                    <li>Conserva este email como comprobante</li>\n                    <li>Descarga nuestra app mÃ³vil con tu nÃºmero de pÃ³liza</li>\n                    <li>En 24h recibirÃ¡s tu tarjeta digital por email</li>\n                    <li>Contacta con nosotros si tienes alguna duda</li>\n                </ol>\n            </div>\n        </div>\n\n        <!-- Contact Information -->\n        <div style=\"background-color: #f8f9fa; padding: 25px 30px; border-top: 3px solid #4CAF50;\">\n            <h4 style=\"color: #333; margin: 0 0 15px 0; font-size: 18px;\">\n                ğŸ“ InformaciÃ³n de Contacto\n            </h4>\n            <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 15px;\">\n                <div>\n                    <p style=\"margin: 0 0 8px 0; color: #555;\">\n                        <strong>ğŸ“ AtenciÃ³n al Cliente:</strong><br>\n                        +57 3128976541  --prueba\n                    </p>\n                    <p style=\"margin: 0; color: #555;\">\n                        <strong>ğŸ“§ Email de Soporte:</strong><br>\n                        correoPrueba@gmail.com\n                    </p>\n                </div>\n                <div>\n                    <p style=\"margin: 0 0 8px 0; color: #555;\">\n                        <strong>ğŸŒ Sitio Web:</strong><br>\n                        www.seguros.com\n                    </p>\n                    <p style=\"margin: 0; color: #555;\">\n                        <strong>â° Horario:</strong><br>\n                        Lunes a Viernes 9:00-18:00\n                    </p>\n                </div>\n            </div>\n        </div>\n\n        <!-- Footer -->\n        <div style=\"background-color: #4CAF50; padding: 25px; text-align: center;\">\n            <h3 style=\"color: white; margin: 0 0 10px 0; font-size: 24px;\">\n                Â¡Gracias por confiar en nosotros! ğŸ’š\n            </h3>\n            <p style=\"color: #e8f5e8; margin: 0; font-size: 14px;\">\n                Este email ha sido generado automÃ¡ticamente. Si tienes dudas, contacta con nosotros.\n            </p>\n        </div>\n        \n    </div>\n</body>\n</html>\n`;\n\nreturn {\n  chatId: $input.first().json.user_id,\n  numeroPoliza,\n  mensajeConfirmacion,\n  emailUsuario: datosUsuario\n};"
      },
      "id": "2d0535ac-40c6-4698-a46f-1cf69f275e99",
      "name": "Generar ConfirmaciÃ³n Final",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1860,
        -780
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "usuarios_seguros",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{$('Telegram Trigger').first().json.message.from.id}}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabaseTool",
      "typeVersion": 1,
      "position": [
        360,
        -380
      ],
      "id": "26b3c8ac-7199-4a8f-a079-e6ab55b2b3fa",
      "name": "Get usuarios_seguros",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "FBCdtgZlNfvohdVd",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "usuarios_seguros",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{ $json.message.from.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -200,
        -560
      ],
      "id": "7f46e74e-56d5-43fc-a0fc-37b10c2d8ea7",
      "name": "primero obtener datos",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "FBCdtgZlNfvohdVd",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "usuarios_seguros",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{$('Telegram Trigger').first().json.message.from.id}}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "numero_poliza",
              "fieldValue": "={{ $json.numeroPoliza }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2080,
        -780
      ],
      "id": "5ff79cef-42dc-4680-a021-0f2c5583d679",
      "name": "actualizar usuarios_seguros",
      "credentials": {
        "supabaseApi": {
          "id": "FBCdtgZlNfvohdVd",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "âœ… ConfirmaciÃ³n de Alta - Seguro MÃ©dico",
        "message": "={{ $('Generar ConfirmaciÃ³n Final').item.json.mensajeConfirmacion }}",
        "options": {
          "bccList": "",
          "ccList": "",
          "replyTo": "soporte@seguros.com"
        }
      },
      "id": "94d0c7f4-1f9c-4196-9913-308a83b19394",
      "name": "Enviar Email ConfirmaciÃ³n",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        2300,
        -780
      ],
      "webhookId": "724f0b7b-b58a-4221-96cf-711ecd887863",
      "credentials": {
        "gmailOAuth2": {
          "id": "LNc5seTrogZWinUW",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2e99ecdc-8c17-4121-9683-c8ee2d37f143",
              "leftValue": "={{ $('AI Agent').item.json.output.parseJson().paso }}",
              "rightValue": "finalizar",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "fd8f7d71-c8a7-4dd9-9ac6-bc8a2d00e3c6",
              "leftValue": "={{ $('AI Agent').item.json.output.parseJson().paso }}",
              "rightValue": "finalizado",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {
          "ignoreCase": true
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1420,
        -680
      ],
      "id": "bd16d7c2-d6db-4577-ba56-40f8241ac3c0",
      "name": "Â¿paso final?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aba9e56d-71da-4270-bc73-fc76aebf0aa3",
              "leftValue": "={{ $('obtener datos').first().json }}",
              "rightValue": "=inicio",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1200,
        -580
      ],
      "id": "8de9dc0d-3259-4fe8-b94a-87e7182ff319",
      "name": "inicio"
    },
    {
      "parameters": {
        "tableId": "conversaciones",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
            },
            {
              "fieldId": "paso_actual",
              "fieldValue": "={{ $('AI Agent').item.json.output.parseJson().paso }}"
            },
            {
              "fieldId": "datos_recopilados",
              "fieldValue": "={{ $('AI Agent').item.json.output.parseJson().datos_extraidos }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1420,
        -480
      ],
      "id": "fe954cef-caa8-4b13-97a5-936588a5aba2",
      "name": "crear datos",
      "credentials": {
        "supabaseApi": {
          "id": "FBCdtgZlNfvohdVd",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "conversaciones",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "datos_recopilados",
              "fieldValue": "={{ $('AI Agent').item.json.output.parseJson().datos_extraidos }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1860,
        -580
      ],
      "id": "c17ec85c-2d02-4b90-be6c-544a7664ce08",
      "name": "actualizar datos",
      "credentials": {
        "supabaseApi": {
          "id": "FBCdtgZlNfvohdVd",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "conversaciones",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{ $('Telegram Trigger').item.json.message.from.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        980,
        -580
      ],
      "id": "1b49532b-cca7-4434-b7a7-3870a53b7152",
      "name": "obtener datos",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "FBCdtgZlNfvohdVd",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dbba3853-d089-4c15-84e8-3f47365d06de",
              "leftValue": "={{ $if($('primero obtener datos').item.json.numero_poliza == undefined,0,$('primero obtener datos').item.json.numero_poliza) }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1640,
        -780
      ],
      "id": "9d5efc6a-c894-45cc-9493-0e1ebda31a9f",
      "name": "Â¿no tiene poliza?"
    },
    {
      "parameters": {
        "jsCode": "function dominioPermitido(email, dominiosPermitidos) {\n  const partes = email.split('@');\n  if (partes.length !== 2) return false;\n\n  const dominio = partes[1].toLowerCase();\n  return dominiosPermitidos.includes(dominio);\n}\nlet respuesta = \"\"; \n// Ejemplo de uso\nconst dominios = [\"gmail.com\", \"hotmail.com\", \"outlook.com\"];\n\nconst regexEmail = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/;\n\nif (regexEmail.test(query)) {\n    if (!dominioPermitido(query, dominios)) {\n     respuesta =  \"ERROR DOMINIO DE EMAIL NO PERMITIDO\";\n    }else{\n      respuesta = query;\n    }\n}else{\n    respuesta = \"ERROR EN FORMATO DE EMAIL\";\n}\n\nreturn respuesta;"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.2,
      "position": [
        500,
        -360
      ],
      "id": "f530e6c0-4d16-4732-8537-df4f6e1e58ed",
      "name": "validar email"
    },
    {
      "parameters": {
        "jsCode": "let respuesta = -1;\nif (query > 17 && query < 80) {\n  respuesta = query;\n}\nreturn respuesta;\n"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.2,
      "position": [
        640,
        -360
      ],
      "id": "cb1cd6a4-edb6-4bf7-ba5e-61b7d2f81f65",
      "name": "validar edad"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -920,
        -720
      ],
      "id": "e63ba3c5-dbab-4203-b5d2-1d43dd239fd7",
      "name": "Telegram get Audio",
      "webhookId": "744afca1-a060-4cc4-9f31-0931245a11b8",
      "credentials": {
        "telegramApi": {
          "id": "vFDkoakc66jpL2B0",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "=data",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -700,
        -720
      ],
      "id": "b95e41cc-6004-4f69-ae85-2b6c2350f656",
      "name": "OpenAI audio a texto",
      "credentials": {
        "openAiApi": {
          "id": "145WhwbclghvLwkm",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nlet mensajeUsuario;\nfor (const item of $input.all()) {\n  if ($('Telegram Trigger').first().json.message.text== null) {\n    mensajeUsuario = $input.first().json.text;\n  }else{\n    mensajeUsuario = $('Telegram Trigger').first().json.message.text;  \n  }\n  \n}\n\nreturn {\"mensajeUsuario\":mensajeUsuario};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        -560
      ],
      "id": "9ea8f8fa-8d01-4b7e-9a46-13238fd9f373",
      "name": "Code un solo texto"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "87a7d4e2-6aa0-4064-9c08-3becf2d901d7",
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1140,
        -580
      ],
      "id": "c21e06dd-f7d8-4e84-8b76-28c73a2fd849",
      "name": "No es texto"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "06fd8f16-b703-4737-8c56-387b6397c946",
              "leftValue": "={{ $('AI Agent').item.json.output.parseJson().datos_extraidos }}",
              "rightValue": "{}",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1640,
        -580
      ],
      "id": "225dae79-1a96-4935-8e27-f2aaa1ddcfba",
      "name": "con datos"
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "No es texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create usuarios_seguros": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Telegram": {
      "main": [
        [
          {
            "node": "obtener datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Generar ConfirmaciÃ³n Final": {
      "main": [
        [
          {
            "node": "actualizar usuarios_seguros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get usuarios_seguros": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "primero obtener datos": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "actualizar usuarios_seguros": {
      "main": [
        [
          {
            "node": "Enviar Email ConfirmaciÃ³n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Â¿paso final?": {
      "main": [
        [
          {
            "node": "Â¿no tiene poliza?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "con datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "inicio": {
      "main": [
        [
          {
            "node": "Â¿paso final?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "crear datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "crear datos": {
      "main": [
        []
      ]
    },
    "obtener datos": {
      "main": [
        [
          {
            "node": "inicio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Â¿no tiene poliza?": {
      "main": [
        [
          {
            "node": "Generar ConfirmaciÃ³n Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validar email": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "validar edad": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Telegram get Audio": {
      "main": [
        [
          {
            "node": "OpenAI audio a texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI audio a texto": {
      "main": [
        [
          {
            "node": "Code un solo texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code un solo texto": {
      "main": [
        [
          {
            "node": "primero obtener datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No es texto": {
      "main": [
        [
          {
            "node": "Telegram get Audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code un solo texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "con datos": {
      "main": [
        [
          {
            "node": "actualizar datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "30b471f5f53c438e8e7718072f35085325c0ab6e8802c2775855362a7d4248b5"
  }
}